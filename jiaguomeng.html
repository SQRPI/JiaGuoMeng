<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <script>
        let runMode = "debug1"

        let gameMode = "Online";
        let lastResult = [["人才公寓", "木屋", "居民楼"], ["五金店", "菜市场", "便利店"], ["食品厂", "电厂", "木材厂"]];

        let oneStars = ["零件厂","民食斋","中式小楼","人民石油","商贸中心","花园洋房","空中别墅","媒体之声","复兴公馆"]
        let towStars = ["企鹅机械","图书城","加油站"]
        let triStars = ["平房","学校","钢铁厂","小型公寓","人才公寓","纺织厂","便利店","服装店","电厂","水厂"]
        let quaStars = ["居民楼","木屋","五金店","木材厂","食品厂","菜市场","造纸厂","钢结构房"]
        let penStars = []


        // 在这里填写你的政策加成。
        // 没加成为0，有100%加成为1，有150%加成为1.5，以此类推。
        let policy = {
            'global': 0,
            'online': 0,
            'offline': 0,
            'residence': 3,
            'commercial': 3,
            'industry': 1,
            'jiaGuoZhiGuang': 0
        }

        // 在这里填写你的照片加成。print(last_result)
        // 数字的意义见上。
        let photos = {
            'global': 0.7,
            'online': 1.2,
            'offline': 0.7,
            'residence': 2.1,
            'commercial': 1.5,
            'industry': 0.9,
        }

        // 在这里填写你的城市任务加成。
        // 数字的意义见上。
        let questsGeneral = {
            'global': 0,
            'online': 0,
            'offline': 0,
            'residence': 0.3,
            'commercial': 0,
            'industry': 0,
        }
        let questsBuilding = {
            '花园洋房': 0,
            '空中别墅': 0,
            '复兴公馆': 0,
            '商贸中心': 0,
            '加油站': 0,
            '人民石油': 0,
            '媒体之声': 0,
            '企鹅机械': 0,
            '中式小楼': 0,
            '零件厂': 0,
            '人才公寓': 0,
            '民食斋': 0,
            '纺织厂': 0,
            '图书城': 0,
            '水厂': 0,
            '电厂': 0,
            '钢铁厂': 0,
            '小型公寓': 0,
            '服装店': 0,
            '木材厂': 0,
            '木屋': 0,
            '菜市场': 0,
            '食品厂': 0,
            '钢结构房': 0,
            '造纸厂': 0,
            '便利店': 0,
            '五金店': 0,
            '平房': 0,
            '居民楼': 0,
            '学校': 0,
            get: function (name, defaultNumber) {
                return this[name] == undefined ? defaultNumber : this[name];
            }
        }

        // 结束配置
        let commercial = ["便利店","五金店","服装店","菜市场","学校","图书城","商贸中心","加油站","民食斋","媒体之声"];
        let residence = ["木屋","居民楼","钢结构房","平房","小型公寓","人才公寓","花园洋房","中式小楼","空中别墅","复兴公馆"];
        let industry  = ["木材厂","食品厂","造纸厂","水厂","电厂","钢铁厂","纺织厂","零件厂","企鹅机械","人民石油"];
        let blackList;

        if (gameMode == "Online") {
            blackList = ["小型公寓", "复兴公馆", "水厂"];
        } else {
            throw "暂时不支持离线模式";
            blackList = ["小型公寓", "电厂"];
        }

        // 去黑名单
        let tmpArr = [commercial, residence, industry, oneStars, towStars, triStars, quaStars, penStars];
        tmpArr.forEach((arr) => {
            removeItemInBlack(arr, blackList);
        })


        // 建立名称 -> 星级的映射
        let starMap = new Map();
        tmpArr = [oneStars, towStars, triStars, quaStars, penStars]
        tmpArr.forEach((buildArr, index) => {
            // 获得星级
            let starNumber = index + 1;

            // 填入映射
            buildArr.forEach(build => {
                starMap.set(build, starNumber);
            })
        })

        // 建立星级-> 倍数map
        let scaleObj = {
            1: 1,
            2: 2,
            3: 6,
            4: 24,
            5: 120
        }

        // 星级 * 政策 * 照片 * 任务
        let startMap = new Map();
        tmpArr = [residence, commercial, industry];
        let tmpObj = {
            residence: residence,
            commercial: commercial,
            industry: industry
        }

        Object.keys(tmpObj).forEach(key => {
            let arr = tmpObj[key];
            arr.forEach((build) => {
                let result =
                    (
                        // 星级
                        scaleObj[starMap.get(build)] *
                        // 政策
                        (1 + policy['global'] + policy['online'] + policy[key] + policy['jiaGuoZhiGuang']) *
                        // 照片
                        (1 + photos['global'] + photos['online'] + photos[key]) *
                        // 任务
                        (1 + questsGeneral['global'] + questsGeneral['online'] + questsGeneral[key] + questsBuilding.get(build, 0))
                    );
                startMap.set(build, result);
            });
        });


        // 自带调整
        let adjustmentObj = {
            "花园洋房": 1.022,
            "商贸中心": 1.022,
            "平房": 1.097,
            "电厂": 1.18,
            "水厂": 1.26,
            "加油站": 1.2,
            "企鹅机械": 1.33,
            "人才公寓": 1.4,
            "中式小楼": 1.4,
            "民食斋": 1.52,
            "空中别墅": 1.52,
            "媒体之声": 1.615
        };

        Object.keys(adjustmentObj).forEach((key) => {
            let adjNum = adjustmentObj[key];
            let newResult;

            // 将没有的值设为0
            if (startMap.get(key) != undefined) {
                newResult = startMap.get(key) * adjNum;
            } else {
                newResult = 0;
            }
            startMap.set(key, newResult);
        });

        let buffs_100 = {
            '木屋': ['木材厂'],
            '居民楼': ['便利店'],
            '钢结构房': ['钢铁厂'],
            '花园洋房': ['商贸中心'],
            '空中别墅': ['民食斋'],
            '便利店': ['居民楼'],
            '五金店': ['零件厂'],
            '服装店': ['纺织厂'],
            '菜市场': ['食品厂'],
            '学校': ['图书城'],
            '图书城': ['学校', '造纸厂'],
            '商贸中心': ['花园洋房'],
            '木材厂': ['木屋'],
            '食品厂': ['菜市场'],
            '造纸厂': ['图书城'],
            '钢铁厂': ['钢结构房'],
            '纺织厂': ['服装店'],
            '零件厂': ['五金店'],
            '企鹅机械': ['零件厂'],
            '人民石油': ['加油站'],
        }

        let buffs_50 = {
            '零件厂': ['企鹅机械'],
            '加油站': ['人民石油'],
        }

        let bufflist_258 = [.2, .5, .8, 1.1, 1.4];
        let bufflist_246 = [.2, .4, .6, .8, 1.0];
        let bufflist_015 = [.2, .4, .6, .8, 1.0]; bufflist_015.map((item, index, arr) => { arr[index] = 0.75 * item; });
        let bufflist_010 = [.2, .4, .6, .8, 1.0]; bufflist_010.map((item, index, arr) => { arr[index] = 0.5 * item; });
        let bufflist_005 = [.2, .4, .6, .8, 1.0]; bufflist_005.map((item, index, arr) => { arr[index] = 0.25 * item; });
        let bufflist_035 = [.2, .4, .6, .8, 1.0]; bufflist_035.map((item, index, arr) => { arr[index] = 1.75 * item; });

        let buffs_com = {
            '媒体之声': bufflist_005,
            '企鹅机械': bufflist_015,
            '民食斋': bufflist_246,
            '纺织厂': bufflist_015,
            '人才公寓': bufflist_246,
            '中式小楼': bufflist_246,
            '空中别墅': bufflist_258,
            '电厂': bufflist_258,
        }

        let buffs_ind = {
            '媒体之声': bufflist_005,
            '钢铁厂': bufflist_015,
            '中式小楼': bufflist_246,
            '民食斋': bufflist_246,
            '空中别墅': bufflist_258,
            '电厂': bufflist_258,
            '企鹅机械': bufflist_258,
            '人才公寓': bufflist_035,
        }

        let buffs_res = {
            '媒体之声': bufflist_005,
            '企鹅机械': bufflist_010,
            '民食斋': bufflist_246,
            '人才公寓': bufflist_246,
            '平房': bufflist_246,
            '空中别墅': bufflist_258,
            '电厂': bufflist_258,
            '中式小楼': bufflist_035,
        }

        // 传入三个数组代表建筑组合，计算出收益
        function calculateComb(buildings) {
            let buildtuple = buildings[0].concat(buildings[1]).concat(buildings[2]);

            let startsArr = [];
            buildtuple.forEach(item => {
                startsArr.push(startMap.get(item));
            })

            let results = [1, 1, 1, 1, 1, 1, 1, 1, 1];
            buildtuple.forEach(item => {
                if (buffs_100.hasOwnProperty(item)) {
                    buffs_100[item].forEach(buffed => {
                        if (buildtuple.indexOf(buffed) != -1) {
                            results[buildtuple.indexOf(buffed)] += starMap.get(item);
                        }
                    })
                }

                if (buffs_50.hasOwnProperty(item)) {
                    buffs_50[item].forEach(buffed => {
                        if (buildtuple.indexOf(buffed) != -1) {
                            results[buildtuple.indexOf(buffed)] += starMap.get(item) * 0.5;
                        }
                    })
                }
                if (buffs_com.hasOwnProperty(item)) {
                    toAdd = buffs_com[item][starMap.get(item) - 1]
                    results[0] += toAdd
                    results[1] += toAdd
                    results[2] += toAdd
                }
                if (buffs_ind.hasOwnProperty(item)) {
                    toAdd = buffs_ind[item][starMap.get(item) - 1]
                    results[3] += toAdd
                    results[4] += toAdd
                    results[5] += toAdd
                }
                if (buffs_res.hasOwnProperty(item)) {
                    toAdd = buffs_res[item][starMap.get(item) - 1]
                    results[6] += toAdd
                    results[7] += toAdd
                    results[8] += toAdd
                }

            })
            let a = 0;
            startsArr.forEach((item, index) => {
                a += item * results[index];
            })

            let b = [];
            startsArr.forEach((item, index) => {
                b.push((item * results[index]) / (scaleObj[starMap.get(buildtuple[index])]));
            })
            return [a, b]
        }

        // 遍历所有可能性，获取最大收益
        let result = { sumRate: -1 }; // 存储一个最优结果
        getAllComb(residence, commercial, industry, (arr) => {
            let calResult = calculateComb(arr);
            let sumRate = calResult[0];

            // 如果某个收益大于已存在收益，就替换保存
            if (sumRate > result.sumRate) {
                let bestBuild = arr[0].concat(arr[1], arr[2]);  // 最优组合
                let additionRatio = calResult[1];               // 加成倍率 ,与上面对应
                let updateOrder = [...bestBuild];               // 复制一份最优组合，用于排序
                let priorityUpgrade = [];                       // 建筑升级优先级
                let rateMap = new Map();                        // 定义一个存储建筑升级优先级的Map

                // 获得建筑升级优先级
                additionRatio.forEach((item, index) => {
                    priorityUpgrade.push(scaleObj[starMap.get(bestBuild[index])] * item);
                })

                // 构建Map
                bestBuild.forEach((item, index) => {
                    rateMap.set(item, priorityUpgrade[index]);
                })

                // 排序得到升级顺序
                updateOrder.sort((a, b) => {
                    return rateMap.get(a) <= rateMap.get(b)?1:-1;
                })

                // 存储结果
                result = {
                    bestBuild: bestBuild,
                    additionRatio: additionRatio,
                    priorityUpgrade: priorityUpgrade,
                    sumRate: sumRate,
                    updateOrder: updateOrder,
                    rateMap: rateMap
                };
            }
        })



        console.log(result);
        //document.getElementsByTagName("body")[0].innerHTML += JSON.stringify(result);

        // 函数开始
        // 处理黑名单
        function removeItemInBlack(itemArr, blackList) {
            itemArr.forEach((item, index) => {
                if (blackList.indexOf(item) > -1) {
                    itemArr.splice(index, 1);
                }
            });
        }

        // 传入数组获得组合
        function getComb(arr, callback) {
            for (let i = 0; i < arr.length; i++) {
                for (let j = i + 1; j < arr.length; j++) {
                    for (let k = j + 1; k < arr.length; k++) {
                        callback([arr[i], arr[j], arr[k]]);
                    }
                }
            }
        }


        // 传入三个数组，获得三个数组的组合
        function getAllComb(residence, commercial, industry, callback) {
            getComb(residence, (arr1) => {
                getComb(commercial, (arr2) => {
                    getComb(industry, (arr3) => {
                        callback([arr1, arr2, arr3])
                    })
                })
            })
        }
        // 函数结束
    </script>
</body>
</html>